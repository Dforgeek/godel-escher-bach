% %% Extend path for input files
% \def\input@path{{../}}%

%%% [Language]
%
%% (English-only setup)
% \usepackage{T1}
% \usepackage[utf8]{inputenc}
%
%% (With Russian)
% \usepackage{cmap}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english,russian]{babel}
%
%% Fix mapping for ligatures
% https://tex.stackexchange.com/a/450394
\input glyphtounicode
\pdfgentounicode=1


%%% [Math packages]
% Note: load this before font packages
\usepackage{amsmath}
\usepackage{mathtools}
% \usepackage{amssymb}
% See docs:
%  https://ctan.org/pkg/amsmath
%  https://ctan.org/pkg/mathtools


%%% [Font setup]
%
%% Plain lmodern
% \usepackage{lmodern}
%
%% Libertine + NewTX-math
\usepackage[tt=false]{libertine}
\usepackage{libertinegc}
\usepackage[varqu,varl]{inconsolata} % typewriter
% \usepackage[scaled=.95]{cabin} % sans serif like Gill Sans
\usepackage[libertine,smallerops]{newtxmath}
%
%% Erewhon + NewTX-math
% \usepackage[scaled=.98,space]{erewhon}
% \usepackage[varqu,varl]{inconsolata} % typewriter
% \usepackage[scaled=.95]{cabin} % sans serif like Gill Sans
% \usepackage[utopia,smallerops]{newtxmath}
% %% \usepackage[type1,scaled=.95]{cabin} % sans serif like Gill Sans
% %% \usepackage[utopia,vvarbb,smallerops]{newtxmath}


%%% [Microtypography]
\usepackage[
    babel=true,% Enable language-specific kerning
    expansion=alltext,
    protrusion=alltext-nott,
    final,% Always enable microtype, even if in draft mode.
]{microtype}


%%% [Common packages]
\usepackage{graphicx}
\usepackage{etoolbox}
\let\providelength\undefined
\let\providecounter\undefined
\usepackage{moredefs}
\usepackage{subfiles}
\usepackage{scalerel}
\usepackage{xspace}
\usepackage{xifthen}
\usepackage{array}
\usepackage{bm}
\usepackage{url}
\usepackage[normalem]{ulem}
\usepackage[usenames]{xcolor}
\usepackage{enumitem}
\usepackage[autostyle]{csquotes}
\usepackage{ragged2e}
\usepackage[Export]{adjustbox}
\usepackage[shortcuts]{extdash}
\usepackage[user,lastpage]{zref}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{tabularx}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{makecell}
\usepackage{longtable}
\usepackage{witharrows}
\usepackage{nicematrix}
\usepackage{ellipsis}
\usepackage{environ}
\usepackage{lipsum}
\usepackage{siunitx}
\usepackage{verse}
\usepackage{paracol}
\usepackage{xlop}
\usepackage{calc}


%%% [Page setup]
%
%% Some necessary macros
\newlength{\alphabet}
\settowidth{\alphabet}{\normalfont abcdefghijklmnopqrstuvwxyz}
%
%% Page geometry
\usepackage{geometry}
\geometry{
    % margin=2cm,
    vmargin=2cm,
    hmargin=3cm,
    % hmargin=1in,
    % textwidth=2.3\alphabet,
    includehead,
    % includefoot,
    heightrounded,
    % showframe,
    % pass,
}
%
% %% Fancy page style
% \usepackage{fancyhdr}
% \pagestyle{fancy}
% \fancyfoot{}
% \fancyfoot[R]{\thepage}
%
%% TOC depth
\settocdepth{section}
\maxtocdepth{section}
%
%% Sections numbering
\setsecnumdepth{chapter}
\maxsecnumdepth{chapter}
%
%% Chapter style for \mainmatter
\makechapterstyle{MyChapterStyle}{
    \renewcommand{\thechapter}{\Roman{chapter}}
    \setlength{\beforechapskip}{0pt}
    \setlength{\midchapskip}{20pt}
    \setlength{\afterchapskip}{20pt}
    \renewcommand*\chapnamefont{\Large\lsstyle\centering\MakeUppercase}
    \renewcommand*\chapnumfont{\chapnamefont}
    \renewcommand*\chaptitlefont{\huge\bfseries\centering}
    \renewcommand*\printchaptertitle[1]{%
        \setlength\tabcolsep{1pc}% used as indentation on both sides
        \settowidth\@tempdimc{\chaptitlefont ##1}%
        \setlength\@tempdimc{\textwidth-\@tempdimc-2\tabcolsep}%
        \chaptitlefont
        \ifdim\@tempdimc > 0pt\relax% one line
            \begin{tabular}{c}
        \else% two+ lines
            \begin{tabular}{%
                >{\chaptitlefont\arraybackslash}p{\textwidth-4pc-2\tabcolsep}
            }
        \fi
            \toprule
            ##1 \\
            \bottomrule
        \end{tabular}
    }
}
%
%% Chapter style for \frontmatter
\makechapterstyle{FrontMatterChapterStyle}{%
    \chapterstyle{MyChapterStyle}
    \renewcommand*{\chapterheadstart}{}
    \renewcommand*{\printchaptername}{}
    \renewcommand*{\printchapternum}{}
    \renewcommand*{\afterchapternum}{}
    \renewcommand*{\chaptitlefont}{\huge\centering}
}
%
%% Chapters style
\chapterstyle{MyChapterStyle}
%% Sections style
\setsecheadstyle{\Large\bfseries\itshape\centering}
%% Subsection style
\setsubsecheadstyle{\large\bfseries\centering}
%
%% Titles
% \usepackage[compact]{titlesec}
% \titleformat{\section}{\large\bfseries}{\thesection}{1em}{}
% \titleformat{\subsection}{\large}{\thesubsection}{.6em}{\flatcaps}
% \titleformat{\subsubsection}{}{\thesubsubsection}{.6em}{}{\itshape}
% \titleformat{\paragraph}[runin]{\flatcaps}{\theparagraph}{0pt}{}
% \titlespacing*{\section}{0pt}{2\baselineskip}{1\baselineskip}
% \titlespacing*{\subsection}{0pt}{1\baselineskip}{1\baselineskip}
% \titlespacing*{\subsubsection}{0pt}{8pt}{5pt}


%%% [TikZ]
\usepackage{tikz}
% See docs: https://www.ctan.org/pkg/pgf
%
%% Template for "tikz-something.tex":
%    \documentclass[../main.tex]{subfiles}%
%    \enabletikzpreview%
%    \begin{document}%
%    \begin{tikzpicture}[...]
%      ...
%    \end{tikzpicture}%
%    \end{document}
%
%% TikZ libraries
\usetikzlibrary{
    arrows.meta,
    automata,
    backgrounds,
    calc,
    fit,
    positioning,
    svg.path,
    trees,
    decorations.pathreplacing,
}
%
%% Common TikZ setup
\tikzset{
    % every text node part/.style={align=center},
}
%
%% Macro to place code only in preamble
% Note: useful for subfiles
\newcommand{\onlyinpreamble}[1]{% {<text>}
    \ifx\@onlypreamble\@notprerr% after \begin{document}
    \else% before \begin{document}
        #1%
    \fi}
%
%% Macro to enable preview for subfiles with TikZ pictures
\newcommand{\enabletikzpreview}[1][2pt]{% [<border>]
    \onlyinpreamble{%
        \usepackage[active,tightpage]{preview}
        \PreviewBorder=#1
        \PreviewEnvironment{tikzpicture}
    }}


%%% [tcolorbox]
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable}
%
%% Horizontal line for tcolorbox
\newcommand{\DrawLine}[1][]{% [<style>]
    \begin{tikzpicture}
        \path[use as bounding box] (0,0) -- (\linewidth,0);
        \draw[dashed,dash phase=2pt,#1]
            (0-\kvtcb@leftlower-\kvtcb@boxsep,0)--
            (\linewidth+\kvtcb@rightlower+\kvtcb@boxsep,0);
    \end{tikzpicture}%
}


%%% [Some stuff]
%
%% New random seed every build
\usepackage{pgf}
\pgfmathsetseed{\number\pdfrandomseed}
%
%% Setup path to images
\graphicspath{{img/}}
%
%% Improve wrapping of URLs: https://tex.stackexchange.com/a/10419/216486
\gappto{\UrlBreaks}{\UrlOrds}
%
%% Custom style for \thead
\renewcommand\theadfont{\bfseries\normalsize}
\renewcommand\theadset{\def\arraystretch{.8}}
%
%% Check the package is loaded. Can be used inside \begin{documen}
\usepackage{ltxcmds}
\newcommand*{\IfPackageLoaded}{\ltx@ifpackageloaded}


%%% [Add your packages below]
% \usepackage{HERE-GOES-YOUR-PACKAGE}


%%% [^^^ Add your packages above ^^^]


%%% [Bookmarks]
% Note: load `bookmark` before `hyperref`
% Note: use [numbered] option to obtain numbered sections
\usepackage{bookmark}


%%% [Hyperlinks]
%
%% Setup hyperref
\usepackage{hyperref}
\hypersetup{
    breaklinks=true,% allow links to break over lines
    pdfstartview=,% empty value leads to using viewer's defaults
    % hidelinks,
    allcolors=black,
    urlcolor=blue,
    linkcolor=red,
    colorlinks=true,
}
%
%% Enable correct jumping to figures when referencing
% \usepackage[all]{hypcap}
%
%% Back-reference from footnote
% \usepackage[numberlinked]{footnotebackref}
% %
% %% Fix '\footnotemark' macro for 'footnotebackref'
% % https://tex.stackexchange.com/a/78438
% \LetLtxMacro{\BHFN@Old@footnotemark}{\@footnotemark}
% \renewcommand*{\@footnotemark}{%
%     \refstepcounter{BackrefHyperFootnoteCounter}%
%     \xdef\BackrefFootnoteTag{bhfn:\theBackrefHyperFootnoteCounter}%
%     \label{\BackrefFootnoteTag}%
%     \BHFN@Old@footnotemark
% }

%%% [Smart references]
% Note: load `cleveref` last
\usepackage[capitalize,nameinlink]{cleveref}
% See docs: https://ctan.org/pkg/cleveref
%
%% Setup cleveref
% \crefname{section}{Sect.}{Sect.}
% \Crefname{section}{Section}{Sections}
% \crefname{appsection}{App.}{App.}
% \Crefname{appsection}{Appendix}{Appendices}


%%% [Setup typography]
%
%% Paragraph indent
\setlength{\parindent}{2pc}
%
%% Rubber \parskip
\abnormalparskip{0pt plus .5ex}
%
%% Emergency stretch
\emergencystretch=1em
%
%% Force TeX not to break in math mode (9999 = almost never)
\relpenalty=9999
\binoppenalty=5000
%
%% Forbid widows/orphans
% Note: \clubpenalty is for orphans
% Note: widow = single line on next page
% Note: orphan (club) = single line on previous page
% \widowpenalty=10000
% \clubpenalty=10000
% \widowpenalties=4 10000 10000 150 0
% \clubpenalties=4 10000 10000 150 0
\widowpenalties=4 9999 9000 150 0
\clubpenalties=4 9999 9000 150 0
%
%% Lines penalty
% Default \linepenalty=10
% \linepenalty=100
%
%% Hyphenation penalty
% Default \hyphenpenalty=10
% Default \tolerance=200
\hyphenpenalty=50
% \tolerance=200
%
%% Hyphenation patterns
\hyphenation{
    сокра-ще-ниях
    испол-не-ние
    поца-ра-пало
}
%
%% Space to intext float
% \setlength\intextsep{4pt plus 6pt}
%
%% Space between text and arbitrary float
% \setlength\textfloatsep{6pt plus 4pt}



%%% [Extra stuff]

%% Simple dialogue
\newlist{dialogue}{itemize}{1}
\setlist[dialogue]{
    topsep=0pt,
    itemsep=0pt plus .5ex,
    parsep=\parskip,
    left=0pt..2pc,
    align=left,
    label={},
    labelsep=4pt,
    itemindent=!,
    before=\SetupDialogue,
}
\newcommand{\SetupDialogue}{%
    %% Character speech
    \newcommand*{\speak}[1]{% {<name>}
        \item[\textit{##1}:]
    }
    %% Stage directions
    \newcommand*{\stage}[1]{% {<text>}
        \vspace{4pt plus 4pt}
        \begin{adjustwidth}{}{2pc}
            ##1
        \end{adjustwidth}
        \vspace{4pt plus 4pt}
    }
    %% Empty item (un-indented)
    % This is useful for inserting text (e.g. \stage) before
    %  the first \item inside list, i.e. before the first \speak.
    \newcommand{\EmptyItem}{%
        \item[]\hspace{-\itemindent}
    }
}

%% Dialogue with levels (dial05)
\NewEnviron{Dialogue}{%
    %% Indent for paragraphs (leftmargin for 2+ lines)
    \providelength{\myindent}
    \setlength{\myindent}{2pc}
    % \setlength{\myindent}{1cm}

    \setlength{\parindent}{\myindent}

    %% Indent for levels
    \providelength{\mywidth}
    \setlength{\mywidth}{4pc}
    % \setlength{\mywidth}{2cm}

    %% Level counter
    \providecounter{level}
    \setcounter{level}{0}

    %% Character speech
    \defcommand*{\speak}[1]{% {<name>}
        \par%
        % \leavevmode% (it is better to explicitly use \noindent)
        \noindent%
        % First line: left=level*mywidth, right=0
        % Next lines: left=level*mywidth+myindent, right=0
        \parshape=2
            \dimexpr\value{level}\mywidth\relax
            \dimexpr\linewidth-\value{level}\mywidth\relax
            \dimexpr\value{level}\mywidth+\myindent\relax
            \dimexpr\linewidth-\value{level}\mywidth-\myindent\relax
        \strut\textit{##1:}\hspace{5pt}\ignorespaces
    }

    %% Stage directions
    \defcommand*{\stage}[1]{% {<text>}
        \par%
        \vspace{4pt plus 4pt}
        % \leavevmode% (it is better to explicitly use \noindent)
        \noindent%
        % All lines: left=level*mywidth+myindent, right=myindent
        \parshape=1
            % Note: subtract \myindent twice in the second expr (width),
            %  in order to make right=\myindent
            \dimexpr\value{level}\mywidth+\myindent\relax
            \dimexpr\linewidth-\value{level}\mywidth-\myindent-\myindent\relax
        {##1\par}
        \vspace{4pt plus 4pt}
    }

    %% Block of stage directions
    \NewEnviron{stageblock}{%
        \par%
        \vspace{4pt plus 4pt}
        \begin{adjustwidth}{\dimexpr\value{level}\mywidth+\myindent\relax}{\myindent}
            \setlength{\parindent}{0pt}
            \BODY
        \end{adjustwidth}
        \vspace{4pt plus 4pt}
    }

    %% Nested dialogue level (auto +1, -1)
    \newenvironment{sublevel}{%
        \par%
        \addtocounter{level}{1}
    }{%
        \par%
        \addtocounter{level}{-1}
    }

    %% Nested dialogue level (custom, auto-reverts)
    \newenvironment{customlevel}[1]{% {<level>}
        \providecounter{level*}% Saved value of 'level'
        \setcounter{level*}{\value{level}}
        \setcounter{level}{##1}
    }{%
        \setcounter{level}{\value{level*}}
    }

    %% Common paragraph: left=level*width, right=0
    \everypar{%
        % (\arabic{level})%
        \parshape=1
            \dimexpr\value{level}\mywidth\relax
            \dimexpr\linewidth-\value{level}\mywidth\relax
    }

    %% The actual content.
    \BODY\par
}

%% Some custom list (used in: dial02)
\newlist{statements}{itemize}{1}
\setlist[statements]{%
    noitemsep,
    topsep=2pt,
    align=left,
    label={},
    labelindent=\parindent,
    labelwidth=2pc,
    labelsep=0pt,
    itemindent=0pt,
    leftmargin=!,
}

%% Block environment
\NewEnviron{block}[1][6pt]{% [<sep>]
    \par
    \vspace{#1}
    \everypar={\parshape=2
        0pt \linewidth
        \parindent \dimexpr\linewidth-\parindent\relax
    }
    \BODY\par
    \vspace{#1}
}

\newcommand*{\centerblock}[1]{% {<text>}
    \vspace{4pt}
    \begin{adjustwidth}{4pc}{4pc}
        \centering
        #1
    \end{adjustwidth}
    \vspace{4pt}
}

%% tcolorbox for defs,rules,axioms,etc
\newtcolorbox{mybox}[2][]{% [<style>]{<title>}
    boxrule=0.4mm,
    enlarge top initially by=2pt,
    enlarge bottom finally by=2pt,
    colback=black!3,
    colbacktitle=black!50,
    title=#2,
    #1,
}
